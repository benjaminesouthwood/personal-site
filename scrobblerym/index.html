<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrobbLeRYM - RYM to Last.fm Scrobbler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-md5/0.8.3/md5.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        .nav a.active {
            font-weight: bold;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card h2 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-row label {
            min-width: 80px;
            font-size: 14px;
            color: #666;
        }
        input[type="text"], input[type="password"], input[type="datetime-local"] {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: monospace;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .connected {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: #d4edda;
            border-radius: 4px;
            color: #155724;
        }
        .connected .username {
            font-weight: bold;
        }
        .album-info {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .album-info .artist {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .album-info .album {
            font-size: 16px;
            color: #666;
            font-style: italic;
        }
        .track-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .track {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }
        .track:last-child {
            border-bottom: none;
        }
        .track:hover {
            background: #f8f9fa;
        }
        .track input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .track .num {
            width: 30px;
            color: #999;
            font-size: 13px;
        }
        .track .title {
            flex: 1;
            font-size: 14px;
        }
        .track .track-artist {
            color: #666;
            font-size: 13px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .track .duration {
            color: #999;
            font-size: 13px;
            min-width: 45px;
            text-align: right;
        }
        .track-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }
        .results {
            margin-top: 15px;
        }
        .result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .result-item.success {
            color: #155724;
        }
        .result-item.error {
            color: #721c24;
        }
        .result-item .icon {
            font-size: 16px;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none !important;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .status-bar {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>ScrobbLeRYM</h1>
    <p class="subtitle">Scrobble RYM albums to Last.fm</p>

    <div class="nav">
        <a href="/rymlfm/">Albums</a>
        <a href="/rymlfm/songs/">Songs</a>
        <a href="/rymlfm/musicleague/">Music League</a>
        <a href="/scrobblerym/" class="active">ScrobbLeRYM</a>
    </div>

    <!-- Last.fm Connection -->
    <div class="card">
        <h2>Last.fm Connection</h2>

        <div id="auth-setup">
            <div class="form-row">
                <label>API Key:</label>
                <input type="text" id="api-key" placeholder="Your Last.fm API key">
            </div>
            <div class="form-row">
                <label>API Secret:</label>
                <input type="password" id="api-secret" placeholder="Your Last.fm API secret">
            </div>
            <p class="help-text">
                Get your API credentials at <a href="https://www.last.fm/api/account/create" target="_blank">last.fm/api/account/create</a>
            </p>
            <div class="form-row" style="margin-top: 15px;">
                <button id="connect-btn" onclick="connectToLastFm()">Connect to Last.fm</button>
                <button class="secondary" onclick="saveCredentials()">Save Credentials</button>
            </div>
        </div>

        <div id="auth-connected" class="hidden">
            <div class="connected">
                <span>Connected as: <span class="username" id="connected-username"></span></span>
                <button class="danger" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div id="auth-error" class="error-message hidden"></div>
    </div>

    <!-- Album Input -->
    <div class="card">
        <h2>Album Input</h2>
        <p class="help-text" style="margin-bottom: 10px;">
            Go to a RYM album page, view page source (Cmd+Option+U on Mac, Ctrl+U on Windows), select all and copy.
        </p>
        <textarea id="html-input" placeholder="Paste the full HTML source of a RYM album page here..."></textarea>
        <div class="form-row" style="margin-top: 10px;">
            <button onclick="parseAlbum()">Parse Album</button>
        </div>
        <div id="parse-error" class="error-message hidden"></div>
    </div>

    <!-- Parsed Album -->
    <div id="album-section" class="card hidden">
        <h2>Parsed Album</h2>
        <div class="album-info">
            <div class="artist" id="album-artist"></div>
            <div class="album" id="album-title"></div>
        </div>
        <div class="track-list" id="track-list"></div>
        <div class="track-actions">
            <button class="secondary" onclick="selectAll()">Select All</button>
            <button class="secondary" onclick="deselectAll()">Deselect All</button>
        </div>
    </div>

    <!-- Scrobble Options -->
    <div id="scrobble-section" class="card hidden">
        <h2>Scrobble</h2>
        <div class="radio-group">
            <label class="radio-option">
                <input type="radio" name="scrobble-time" value="now" checked>
                <span>Just finished listening</span>
            </label>
            <label class="radio-option">
                <input type="radio" name="scrobble-time" value="custom">
                <span>Started at:</span>
                <input type="datetime-local" id="custom-time">
            </label>
        </div>
        <div class="form-row" style="margin-top: 20px;">
            <button class="success" onclick="scrobble()" id="scrobble-btn">Scrobble Selected Tracks</button>
        </div>
        <div id="scrobble-status" class="status-bar hidden"></div>
        <div id="scrobble-results" class="results hidden"></div>
    </div>

    <script>
        // State
        let parsedAlbum = null;
        let sessionKey = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved credentials
            const savedKey = localStorage.getItem('lastfm_api_key');
            const savedSecret = localStorage.getItem('lastfm_api_secret');
            if (savedKey) document.getElementById('api-key').value = savedKey;
            if (savedSecret) document.getElementById('api-secret').value = savedSecret;

            // Check for existing session
            sessionKey = localStorage.getItem('lastfm_session_key');
            const username = localStorage.getItem('lastfm_username');
            if (sessionKey && username) {
                showConnected(username);
            }

            // Check for auth callback token
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                handleAuthCallback(token);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Set default custom time to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('custom-time').value = now.toISOString().slice(0, 16);
        });

        // Generate API signature
        function generateSignature(params, secret) {
            const sortedKeys = Object.keys(params).sort();
            let sigString = '';
            for (const key of sortedKeys) {
                sigString += key + params[key];
            }
            sigString += secret;
            return md5(sigString);
        }

        // Save credentials to localStorage
        function saveCredentials() {
            const apiKey = document.getElementById('api-key').value.trim();
            const apiSecret = document.getElementById('api-secret').value.trim();
            if (apiKey) localStorage.setItem('lastfm_api_key', apiKey);
            if (apiSecret) localStorage.setItem('lastfm_api_secret', apiSecret);
            alert('Credentials saved!');
        }

        // Connect to Last.fm
        function connectToLastFm() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                showAuthError('Please enter your API key');
                return;
            }

            // Save credentials before redirect
            saveCredentials();

            // Redirect to Last.fm auth
            const callbackUrl = window.location.origin + window.location.pathname;
            const authUrl = `https://www.last.fm/api/auth/?api_key=${apiKey}&cb=${encodeURIComponent(callbackUrl)}`;
            window.location.href = authUrl;
        }

        // Handle auth callback
        async function handleAuthCallback(token) {
            const apiKey = localStorage.getItem('lastfm_api_key');
            const apiSecret = localStorage.getItem('lastfm_api_secret');

            if (!apiKey || !apiSecret) {
                showAuthError('Missing API credentials. Please enter and save them first.');
                return;
            }

            const params = {
                method: 'auth.getSession',
                api_key: apiKey,
                token: token
            };
            params.api_sig = generateSignature(params, apiSecret);
            params.format = 'json';

            try {
                const response = await fetch('https://ws.audioscrobbler.com/2.0/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(params)
                });

                const data = await response.json();

                if (data.error) {
                    showAuthError(`Last.fm error: ${data.message}`);
                    return;
                }

                sessionKey = data.session.key;
                const username = data.session.name;

                localStorage.setItem('lastfm_session_key', sessionKey);
                localStorage.setItem('lastfm_username', username);

                showConnected(username);
            } catch (err) {
                showAuthError(`Connection failed: ${err.message}`);
            }
        }

        // Show connected state
        function showConnected(username) {
            document.getElementById('auth-setup').classList.add('hidden');
            document.getElementById('auth-connected').classList.remove('hidden');
            document.getElementById('connected-username').textContent = username;
            document.getElementById('auth-error').classList.add('hidden');
        }

        // Disconnect
        function disconnect() {
            localStorage.removeItem('lastfm_session_key');
            localStorage.removeItem('lastfm_username');
            sessionKey = null;
            document.getElementById('auth-setup').classList.remove('hidden');
            document.getElementById('auth-connected').classList.add('hidden');
        }

        // Show auth error
        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        // Parse RYM album HTML
        function parseAlbum() {
            const html = document.getElementById('html-input').value;
            if (!html.trim()) {
                showParseError('Please paste the HTML source of a RYM album page');
                return;
            }

            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Get album title
                const albumTitleEl = doc.querySelector('.album_title');
                let albumTitle = '';
                if (albumTitleEl) {
                    // Get text content, but filter out child elements that might be artist names
                    const titleClone = albumTitleEl.cloneNode(true);
                    const byArtist = titleClone.querySelector('.album_artist');
                    if (byArtist) byArtist.remove();
                    albumTitle = titleClone.textContent.trim();
                }
                if (!albumTitle) {
                    albumTitle = doc.querySelector('[itemprop="name"]')?.textContent?.trim() || '';
                }

                // Get artist
                let artist = '';
                const artistLink = doc.querySelector('span[itemprop="byArtist"] a');
                if (artistLink) {
                    artist = artistLink.textContent.trim();
                }
                if (!artist) {
                    const creditedName = doc.querySelector('.credited_name a');
                    if (creditedName) artist = creditedName.textContent.trim();
                }
                if (!artist) {
                    const albumArtist = doc.querySelector('.album_artist a');
                    if (albumArtist) artist = albumArtist.textContent.trim();
                }

                const isVariousArtists = artist.toLowerCase().includes('various artists') ||
                                         artist.includes(' / ');

                // Get tracks
                const tracksContainer = doc.getElementById('tracks');
                const trackLines = tracksContainer ?
                    tracksContainer.querySelectorAll('.tracklist_line, .track') :
                    doc.querySelectorAll('.tracklist_line, .track');

                const tracks = [];
                trackLines.forEach((line, index) => {
                    // Track number
                    const numEl = line.querySelector('.tracklist_num, .tracknum');
                    const trackNum = numEl ? parseInt(numEl.textContent.trim()) || (index + 1) : (index + 1);

                    // Track title
                    let trackTitle = '';
                    const titleEl = line.querySelector('.tracklist_title .rendered_text, .tracklist_title, [itemprop="name"], .tracktitle');
                    if (titleEl) {
                        trackTitle = titleEl.textContent.trim();
                    }

                    // Duration
                    let duration = 180; // default 3 min
                    let durationStr = '';
                    const durationEl = line.querySelector('.tracklist_duration, .duration');
                    if (durationEl) {
                        durationStr = durationEl.textContent.trim();
                        const parts = durationStr.split(':').map(Number);
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                            duration = parts[0] * 60 + parts[1];
                        } else if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                            duration = parts[0] * 3600 + parts[1] * 60 + parts[2];
                        }
                    }

                    // Per-track artist (for VA compilations)
                    let trackArtist = artist;
                    if (isVariousArtists) {
                        const artistEl = line.querySelector('.artist a, .credited_artist a');
                        if (artistEl) {
                            trackArtist = artistEl.textContent.trim();
                        }
                    }

                    if (trackTitle) {
                        tracks.push({
                            number: trackNum,
                            title: trackTitle,
                            artist: trackArtist,
                            duration: duration,
                            durationStr: durationStr || formatDuration(duration),
                            selected: true
                        });
                    }
                });

                if (tracks.length === 0) {
                    showParseError('Could not find any tracks. Make sure you copied the full page source from a RYM album page.');
                    return;
                }

                parsedAlbum = {
                    artist: artist,
                    title: albumTitle,
                    isVariousArtists: isVariousArtists,
                    tracks: tracks
                };

                displayAlbum();
                document.getElementById('parse-error').classList.add('hidden');

            } catch (err) {
                showParseError(`Parse error: ${err.message}`);
            }
        }

        // Format duration in seconds to MM:SS
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Display parsed album
        function displayAlbum() {
            document.getElementById('album-artist').textContent = parsedAlbum.artist || 'Unknown Artist';
            document.getElementById('album-title').textContent = parsedAlbum.title || 'Unknown Album';

            const trackListEl = document.getElementById('track-list');
            trackListEl.innerHTML = '';

            parsedAlbum.tracks.forEach((track, index) => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track';
                trackEl.innerHTML = `
                    <input type="checkbox" ${track.selected ? 'checked' : ''} onchange="toggleTrack(${index})">
                    <span class="num">${track.number}.</span>
                    <span class="title">${escapeHtml(track.title)}</span>
                    ${parsedAlbum.isVariousArtists ? `<span class="track-artist">${escapeHtml(track.artist)}</span>` : ''}
                    <span class="duration">${track.durationStr}</span>
                `;
                trackListEl.appendChild(trackEl);
            });

            document.getElementById('album-section').classList.remove('hidden');
            document.getElementById('scrobble-section').classList.remove('hidden');
            document.getElementById('scrobble-results').classList.add('hidden');
            document.getElementById('scrobble-status').classList.add('hidden');
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle track selection
        function toggleTrack(index) {
            parsedAlbum.tracks[index].selected = !parsedAlbum.tracks[index].selected;
        }

        // Select all tracks
        function selectAll() {
            parsedAlbum.tracks.forEach(t => t.selected = true);
            displayAlbum();
        }

        // Deselect all tracks
        function deselectAll() {
            parsedAlbum.tracks.forEach(t => t.selected = false);
            displayAlbum();
        }

        // Show parse error
        function showParseError(message) {
            const el = document.getElementById('parse-error');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        // Scrobble tracks
        async function scrobble() {
            if (!sessionKey) {
                alert('Please connect to Last.fm first');
                return;
            }

            if (!parsedAlbum) {
                alert('Please parse an album first');
                return;
            }

            const selectedTracks = parsedAlbum.tracks.filter(t => t.selected);
            if (selectedTracks.length === 0) {
                alert('Please select at least one track');
                return;
            }

            const apiKey = localStorage.getItem('lastfm_api_key');
            const apiSecret = localStorage.getItem('lastfm_api_secret');

            // Calculate timestamps
            const timeMode = document.querySelector('input[name="scrobble-time"]:checked').value;
            let timestamps = [];

            if (timeMode === 'now') {
                // Work backwards from now
                let time = Date.now();
                for (let i = selectedTracks.length - 1; i >= 0; i--) {
                    time -= selectedTracks[i].duration * 1000;
                    timestamps[i] = Math.floor(time / 1000);
                }
            } else {
                // Work forwards from custom time
                const customTime = new Date(document.getElementById('custom-time').value);
                let time = customTime.getTime();
                for (let i = 0; i < selectedTracks.length; i++) {
                    timestamps[i] = Math.floor(time / 1000);
                    time += selectedTracks[i].duration * 1000;
                }
            }

            // Disable button during scrobble
            const btn = document.getElementById('scrobble-btn');
            btn.disabled = true;
            btn.textContent = 'Scrobbling...';

            const statusEl = document.getElementById('scrobble-status');
            statusEl.classList.remove('hidden');

            const resultsEl = document.getElementById('scrobble-results');
            resultsEl.innerHTML = '';
            resultsEl.classList.remove('hidden');

            let successCount = 0;
            let errorCount = 0;

            // Scrobble each track
            for (let i = 0; i < selectedTracks.length; i++) {
                const track = selectedTracks[i];
                statusEl.textContent = `Scrobbling ${i + 1}/${selectedTracks.length}: ${track.title}`;

                const params = {
                    method: 'track.scrobble',
                    artist: track.artist,
                    track: track.title,
                    timestamp: timestamps[i].toString(),
                    api_key: apiKey,
                    sk: sessionKey
                };

                if (parsedAlbum.title) {
                    params.album = parsedAlbum.title;
                }

                params.api_sig = generateSignature(params, apiSecret);
                params.format = 'json';

                try {
                    const response = await fetch('https://ws.audioscrobbler.com/2.0/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(params)
                    });

                    const data = await response.json();

                    if (data.error) {
                        errorCount++;
                        addResult(track.title, false, data.message);
                    } else if (data.scrobbles && data.scrobbles['@attr'] && data.scrobbles['@attr'].ignored > 0) {
                        errorCount++;
                        addResult(track.title, false, 'Track ignored by Last.fm');
                    } else {
                        successCount++;
                        const time = new Date(timestamps[i] * 1000);
                        addResult(track.title, true, `Scrobbled at ${time.toLocaleTimeString()}`);
                    }
                } catch (err) {
                    errorCount++;
                    addResult(track.title, false, err.message);
                }

                // Small delay between requests
                if (i < selectedTracks.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            statusEl.textContent = `Done! ${successCount} scrobbled, ${errorCount} failed`;
            btn.disabled = false;
            btn.textContent = 'Scrobble Selected Tracks';
        }

        // Add result to results list
        function addResult(trackTitle, success, message) {
            const resultsEl = document.getElementById('scrobble-results');
            const resultEl = document.createElement('div');
            resultEl.className = `result-item ${success ? 'success' : 'error'}`;
            resultEl.innerHTML = `
                <span class="icon">${success ? '✓' : '✗'}</span>
                <span><strong>${escapeHtml(trackTitle)}</strong> - ${escapeHtml(message)}</span>
            `;
            resultsEl.appendChild(resultEl);
        }
    </script>
</body>
</html>
